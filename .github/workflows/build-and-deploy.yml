name: Build & Deploy FF Dashboard to Unraid

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches: [ main, dev ]
  workflow_dispatch:

concurrency:
  group: ff-dashboard
  cancel-in-progress: true

jobs:
  build-and-deploy:
    # Only run if CI workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: self-hosted
    env:
      HOME: /home/github

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      # Decide tags based on branch (main -> latest, dev -> dev)
      - name: Set image tags
        id: vars
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "BACKEND_TAG=latest" >> $GITHUB_OUTPUT
            echo "FRONTEND_TAG=latest" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_REF_NAME}" == "dev" ]]; then
            echo "BACKEND_TAG=dev" >> $GITHUB_OUTPUT
            echo "FRONTEND_TAG=dev" >> $GITHUB_OUTPUT
          else
            # Fallback (not really used with current triggers)
            echo "BACKEND_TAG=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
            echo "FRONTEND_TAG=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ghcr.io/${{ secrets.GHCR_USERNAME }}/ff-dashboard-backend:${{ steps.vars.outputs.BACKEND_TAG }}
            ghcr.io/${{ secrets.GHCR_USERNAME }}/ff-dashboard-backend:${{ github.sha }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ secrets.GHCR_USERNAME }}/ff-dashboard:${{ steps.vars.outputs.FRONTEND_TAG }}
            ghcr.io/${{ secrets.GHCR_USERNAME }}/ff-dashboard:${{ github.sha }}

      - name: Deploy updated stack on Unraid
        run: |
          /usr/bin/bash /boot/config/custom/deploy_ff_dashboard.sh
      
      - name: Cleanup dangling Docker images
        run: |
          docker image prune -f
